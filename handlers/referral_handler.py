# handlers/referral_handler.py

from aiogram import Router, types, F
from aiogram import Bot  # –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
from keyboards.monetization import get_referral_keyboard
from repositories.users.user_repo import get_confirmed_count
from config import REFERRAL_BANNER_PATH, REFERRAL_BASE_URL
import os

router = Router()

@router.callback_query(F.data == "monetization_referral")
async def show_referral_info(callback: types.CallbackQuery, bot: Bot, db):
    user_id = callback.from_user.id

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    cursor = await db.execute("""
        SELECT invited_id, is_active 
        FROM referrals 
        WHERE referrer_id = ?
    """, (user_id,))
    referrals = await cursor.fetchall()

    total_referrals = len(referrals)
    active_referrals = sum(1 for _, is_active in referrals if is_active)

    referral_link = f"{REFERRAL_BASE_URL}?start={user_id}"

    caption = (
        "<b>üë• –¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\n"
        f"üîó <b>–°—Å—ã–ª–∫–∞:</b> {referral_link}\n\n"
        f"üìä –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: <b>{total_referrals}</b>\n"
        f"üî• –ê–∫—Ç–∏–≤–Ω—ã—Ö: <b>{active_referrals}</b>\n\n"
        "ü§ë –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!"
    )

    await callback.message.edit_media(
        media=types.InputMediaPhoto(
            media=types.FSInputFile(REFERRAL_BANNER_PATH),
            caption=caption,
            parse_mode="HTML"
        ),
        reply_markup=get_referral_keyboard(referral_link)
    )

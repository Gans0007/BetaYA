from database import get_pool
from aiogram import Bot
from config import BOT_TOKEN  # –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —É —Ç–µ–±—è –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ ‚Äî —É–∫–∞–∂–∏ –ø—É—Ç—å
bot = Bot(token=BOT_TOKEN)

# XP –∑–∞ —É—Ä–æ–≤–Ω–∏ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
XP_LEVELS = {
    "0": 1.0,   # –ù–æ–≤–∏—á–æ–∫
    "1": 1.2,   # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    "2": 1.4,   # –§–æ–∫—É—Å –∏ —ç–Ω–µ—Ä–≥–∏—è
    "3": 1.6,   # –°–∞–º–æ–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞
    "4": 1.8,   # –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ
}

# XP –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–≤—ã—á–µ–∫
XP_DIFFICULTY = {
    1: 1.0,   # ‚≠ê –õ–µ–≥–∫–æ
    2: 1.3,   # ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ
    3: 1.6,   # ‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ
}


# ------------------------------------------
# –õ–∏–≥–∏ –∏ –∏—Ö —É—Å–ª–æ–≤–∏—è + —Ü–∏—Ç–∞—Ç–∞
# ------------------------------------------
LEAGUES = [
    {
        "name": "–ë–µ–∑–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
        "emoji": "üï≥Ô∏è",
        "stars": 0,
        "xp": 0,
        "quote": "–ü–æ–≥–ª–æ—â—ë–Ω –ª–µ–Ω—å—é –∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è–º–∏. –í—Å—ë –≤—Ä–µ–º—è ¬´–ø–æ—Ç–æ–º¬ª. –ù–∞—á–∞–ª–æ –ø—É—Ç–∏ ‚Äî –Ω–æ–ª—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏."
    },
    {
        "name": "–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è",
        "emoji": "üå´Ô∏è",
        "stars": 2,
        "xp": 50,
        "quote": "–•–æ—á–µ—Ç –º–µ–Ω—è—Ç—å—Å—è, –Ω–æ —Ç—É–º–∞–Ω —Å–æ–º–Ω–µ–Ω–∏–π –º–µ—à–∞–µ—Ç –≤–∏–¥–µ—Ç—å –ø—É—Ç—å."
    },
    {
        "name": "–ù–æ–≤–∏—á–æ–∫",
        "emoji": "üå±",
        "stars": 5,
        "xp": 150,
        "quote": "–°–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π —à–∞–≥. –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä–æ—Å—Ç–æ–∫ —á–µ—Ä–µ–∑ –±–µ—Ç–æ–Ω –ø—Ä–∏–≤—ã—á–µ–∫."
    },
    {
        "name": "–£—á–µ–Ω–∏–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã",
        "emoji": "üî•",
        "stars": 10,
        "xp": 350,
        "quote": "–£—á–∏—Ç—Å—è —Ç–µ—Ä–ø–µ–Ω–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—é. –£–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç –≤–∫—É—Å –ø–æ–±–µ–¥—ã –Ω–∞–¥ —Å–æ–±–æ–π."
    },
    {
        "name": "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
        "emoji": "üõ°Ô∏è",
        "stars": 20,
        "xp": 700,
        "quote": "–î–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ. –î–µ–ª–∞–µ—Ç, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –Ω–µ —Ö–æ—á–µ—Ç—Å—è."
    },
    {
        "name": "–ñ–µ–ª–µ–∑–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
        "emoji": "‚öîÔ∏è",
        "stars": 35,
        "xp": 1200,
        "quote": "–ù–µ —Å–¥–∞—ë—Ç—Å—è. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –∫–∞–∫ –±–æ–π —Å —Å–∞–º–∏–º —Å–æ–±–æ–π."
    },
    {
        "name": "–õ–∏–¥–µ—Ä –ø—Ä–∏–º–µ—Ä–∞",
        "emoji": "ü¶Å",
        "stars": 55,
        "xp": 2000,
        "quote": "–î–µ–π—Å—Ç–≤–∏—è–º–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –¥—Ä—É–≥–∏—Ö. –õ–∏–¥–µ—Ä ‚Äî –Ω–µ –ø–æ —Å–ª–æ–≤–∞–º, –∞ –ø–æ –ø–æ—Å—Ç—É–ø–∫–∞–º."
    },
    {
        "name": "–ù–µ–ø–æ–∫–æ–ª–µ–±–∏–º—ã–π",
        "emoji": "ü™®",
        "stars": 80,
        "xp": 3000,
        "quote": "–ù–∏–∫–∞–∫–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ –º–æ–≥—É—Ç —Å–±–∏—Ç—å —Å –∫—É—Ä—Å–∞."
    },
    {
        "name": "–ú–∞—Å—Ç–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—è",
        "emoji": "üßò‚Äç‚ôÇÔ∏è",
        "stars": 110,
        "xp": 4500,
        "quote": "–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ä–∞–∑—É–º, —Ç–µ–ª–æ –∏ —ç–º–æ—Ü–∏–∏. –°–ø–æ–∫–æ–µ–Ω –≤–Ω—É—Ç—Ä–∏ ‚Äî –º–æ—â–µ–Ω —Å–Ω–∞—Ä—É–∂–∏."
    },
    {
        "name": "–°–æ–∑–∏–¥–∞—Ç–µ–ª—å",
        "emoji": "üåÖ",
        "stars": 150,
        "xp": 6500,
        "quote": "–°–æ–∑–¥–∞–µ—Ç, –∞ –Ω–µ —Ä–∞–∑—Ä—É—à–∞–µ—Ç. –í–µ–¥—ë—Ç, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç, —Å–æ–∑–∏–¥–∞–µ—Ç –Ω–æ–≤—ã–π –º–∏—Ä."
    },
]

async def add_xp_for_confirmation(user_id: int, habit_id: int):
    """–ù–∞—á–∏—Å–ª—è–µ—Ç XP –∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏/—á–µ–ª–ª–µ–Ω–¥–∂–∞."""
    pool = await get_pool()

    async with pool.acquire() as conn:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏
        habit = await conn.fetchrow("""
            SELECT is_challenge, challenge_id, difficulty
            FROM habits
            WHERE id = $1
        """, habit_id)

        if not habit:
            return  # –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–µ—Ç ‚Üí XP –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ–º

        # ------------------------------------------
        # 1) –ß–ï–õ–õ–ï–ù–î–ñ ‚Üí XP –ø–æ —É—Ä–æ–≤–Ω—é
        # ------------------------------------------
        if habit["is_challenge"]:
            level_key = habit["challenge_id"][0]
            xp_gain = XP_LEVELS.get(level_key, 1.0)

        # ------------------------------------------
        # 2) –ü–†–ò–í–´–ß–ö–ê ‚Üí XP –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        # ------------------------------------------
        else:
            diff = habit["difficulty"] or 1
            xp_gain = XP_DIFFICULTY.get(diff, 1.0)

        # ------------------------------------------
        # –ù–∞—á–∏—Å–ª—è–µ–º XP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        # ------------------------------------------
        await conn.execute("""
            UPDATE users
            SET xp = xp + $1
            WHERE user_id = $2
        """, xp_gain, user_id)

        return xp_gain

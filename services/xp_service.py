from database import get_pool
from aiogram import Bot
from config import BOT_TOKEN  # ÐµÑÐ»Ð¸ Ñ‚Ð¾ÐºÐµÐ½ Ñƒ Ñ‚ÐµÐ±Ñ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ â€” ÑƒÐºÐ°Ð¶Ð¸ Ð¿ÑƒÑ‚ÑŒ
bot = Bot(token=BOT_TOKEN)

# XP Ð·Ð° ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶ÐµÐ¹
XP_LEVELS = {
    "0": 1.0,   # ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº
    "1": 1.2,   # ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
    "2": 1.4,   # Ð¤Ð¾ÐºÑƒÑ Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ñ
    "3": 1.6,   # Ð¡Ð°Ð¼Ð¾Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½Ð°
    "4": 1.8,   # ÐŸÑ€ÐµÐ¾Ð´Ð¾Ð»ÐµÐ½Ð¸Ðµ
}

# XP Ð·Ð° ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº
XP_DIFFICULTY = {
    1: 1.0,   # â­ Ð›ÐµÐ³ÐºÐ¾
    2: 1.3,   # â­â­ Ð¡Ñ€ÐµÐ´Ð½Ðµ
    3: 1.6,   # â­â­â­ Ð¡Ð»Ð¾Ð¶Ð½Ð¾
}


# ------------------------------------------
# Ð›Ð¸Ð³Ð¸ Ð¸ Ð¸Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ñ + Ñ†Ð¸Ñ‚Ð°Ñ‚Ð°
# ------------------------------------------
LEAGUES = [
    {
        "name": "Ð‘ÐµÐ·Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹",
        "emoji": "ðŸ•³ï¸",
        "stars": 0,
        "xp": 0,
        "quote": "ÐŸÐ¾Ð³Ð»Ð¾Ñ‰Ñ‘Ð½ Ð»ÐµÐ½ÑŒÑŽ Ð¸ Ð¾Ð¿Ñ€Ð°Ð²Ð´Ð°Ð½Ð¸ÑÐ¼Ð¸. Ð’ÑÑ‘ Ð²Ñ€ÐµÐ¼Ñ Â«Ð¿Ð¾Ñ‚Ð¾Ð¼Â». ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿ÑƒÑ‚Ð¸ â€” Ð½Ð¾Ð»ÑŒ Ð¾ÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸."
    },
    {
        "name": "Ð¡Ð¾Ð¼Ð½ÐµÐ²Ð°ÑŽÑ‰Ð¸Ð¹ÑÑ",
        "emoji": "ðŸŒ«ï¸",
        "stars": 2,
        "xp": 50,
        "quote": "Ð¥Ð¾Ñ‡ÐµÑ‚ Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ, Ð½Ð¾ Ñ‚ÑƒÐ¼Ð°Ð½ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ð¹ Ð¼ÐµÑˆÐ°ÐµÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ."
    },
    {
        "name": "ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº",
        "emoji": "ðŸŒ±",
        "stars": 5,
        "xp": 150,
        "quote": "Ð¡Ð´ÐµÐ»Ð°Ð» Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³. ÐœÐ°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ñ€Ð¾ÑÑ‚Ð¾Ðº Ñ‡ÐµÑ€ÐµÐ· Ð±ÐµÑ‚Ð¾Ð½ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº."
    },
    {
        "name": "Ð£Ñ‡ÐµÐ½Ð¸Ðº Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½Ñ‹",
        "emoji": "ðŸ”¥",
        "stars": 10,
        "xp": 350,
        "quote": "Ð£Ñ‡Ð¸Ñ‚ÑÑ Ñ‚ÐµÑ€Ð¿ÐµÐ½Ð¸ÑŽ Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŽ. Ð£Ð¶Ðµ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑ‚ Ð²ÐºÑƒÑ Ð¿Ð¾Ð±ÐµÐ´Ñ‹ Ð½Ð°Ð´ ÑÐ¾Ð±Ð¾Ð¹."
    },
    {
        "name": "ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹",
        "emoji": "ðŸ›¡ï¸",
        "stars": 20,
        "xp": 700,
        "quote": "Ð”ÐµÑ€Ð¶Ð¸Ñ‚ ÑÐ»Ð¾Ð²Ð¾. Ð”ÐµÐ»Ð°ÐµÑ‚, Ð´Ð°Ð¶Ðµ ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑ‚ÑÑ."
    },
    {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ñ‹Ð¹ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€",
        "emoji": "âš”ï¸",
        "stars": 35,
        "xp": 1200,
        "quote": "ÐÐµ ÑÐ´Ð°Ñ‘Ñ‚ÑÑ. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ â€” ÐºÐ°Ðº Ð±Ð¾Ð¹ Ñ ÑÐ°Ð¼Ð¸Ð¼ ÑÐ¾Ð±Ð¾Ð¹."
    },
    {
        "name": "Ð›Ð¸Ð´ÐµÑ€ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°",
        "emoji": "ðŸ¦",
        "stars": 55,
        "xp": 2000,
        "quote": "Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸ÑÐ¼Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð´Ñ€ÑƒÐ³Ð¸Ñ…. Ð›Ð¸Ð´ÐµÑ€ â€” Ð½Ðµ Ð¿Ð¾ ÑÐ»Ð¾Ð²Ð°Ð¼, Ð° Ð¿Ð¾ Ð¿Ð¾ÑÑ‚ÑƒÐ¿ÐºÐ°Ð¼."
    },
    {
        "name": "ÐÐµÐ¿Ð¾ÐºÐ¾Ð»ÐµÐ±Ð¸Ð¼Ñ‹Ð¹",
        "emoji": "ðŸª¨",
        "stars": 80,
        "xp": 3000,
        "quote": "ÐÐ¸ÐºÐ°ÐºÐ¸Ðµ Ð¾Ð±ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð° Ð½Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ±Ð¸Ñ‚ÑŒ Ñ ÐºÑƒÑ€ÑÐ°."
    },
    {
        "name": "ÐœÐ°ÑÑ‚ÐµÑ€ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ñ",
        "emoji": "ðŸ§˜â€â™‚ï¸",
        "stars": 110,
        "xp": 4500,
        "quote": "ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°Ð·ÑƒÐ¼, Ñ‚ÐµÐ»Ð¾ Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¸. Ð¡Ð¿Ð¾ÐºÐ¾ÐµÐ½ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ â€” Ð¼Ð¾Ñ‰ÐµÐ½ ÑÐ½Ð°Ñ€ÑƒÐ¶Ð¸."
    },
    {
        "name": "Ð¡Ð¾Ð·Ð¸Ð´Ð°Ñ‚ÐµÐ»ÑŒ",
        "emoji": "ðŸŒ…",
        "stars": 150,
        "xp": 6500,
        "quote": "Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚, Ð° Ð½Ðµ Ñ€Ð°Ð·Ñ€ÑƒÑˆÐ°ÐµÑ‚. Ð’ÐµÐ´Ñ‘Ñ‚, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÐµÑ‚, ÑÐ¾Ð·Ð¸Ð´Ð°ÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¼Ð¸Ñ€."
    },
]

async def add_xp_for_confirmation(user_id: int, habit_id: int):
    """ÐÐ°Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ XP Ð·Ð° ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸/Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°."""
    pool = await get_pool()

    async with pool.acquire() as conn:
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸
        habit = await conn.fetchrow("""
            SELECT is_challenge, challenge_id, difficulty
            FROM habits
            WHERE id = $1
        """, habit_id)

        if not habit:
            return  # Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸ Ð½ÐµÑ‚ â†’ XP Ð½Ðµ Ð½Ð°Ñ‡Ð¸ÑÐ»ÑÐµÐ¼

        # ------------------------------------------
        # 1) Ð§Ð•Ð›Ð›Ð•ÐÐ”Ð– â†’ XP Ð¿Ð¾ ÑƒÑ€Ð¾Ð²Ð½ÑŽ
        # ------------------------------------------
        if habit["is_challenge"]:
            level_key = habit["challenge_id"][0]
            xp_gain = XP_LEVELS.get(level_key, 1.0)

        # ------------------------------------------
        # 2) ÐŸÐ Ð˜Ð’Ð«Ð§ÐšÐ â†’ XP Ð¿Ð¾ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
        # ------------------------------------------
        else:
            diff = habit["difficulty"] or 1
            xp_gain = XP_DIFFICULTY.get(diff, 1.0)

        # ------------------------------------------
        # ÐÐ°Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ XP Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
        # ------------------------------------------
        await conn.execute("""
            UPDATE users
            SET xp = xp + $1
            WHERE user_id = $2
        """, xp_gain, user_id)

        return xp_gain


# ------------------------------------------
# ðŸ”¥ Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ñ Ð»Ð¸Ð³Ð¸
# ------------------------------------------
async def check_next_league(user_id: int):
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð»Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð°Ñ Ð»Ð¸Ð³Ð°.
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚:
    {
        "can_level_up": bool,
        "current_league": str,
        "next_league": dict | None,
        "need_stars": int,
        "need_xp": float
    }
    """

    pool = await get_pool()
    async with pool.acquire() as conn:
        user = await conn.fetchrow("""
            SELECT xp, total_stars, league
            FROM users
            WHERE user_id = $1
        """, user_id)

    if not user:
        return {"can_level_up": False, "next_league": None}

    xp_user = float(user["xp"])
    stars_user = int(user["total_stars"])
    current_league = user["league"]

    # Ð¸Ð½Ð´ÐµÐºÑ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð»Ð¸Ð³Ð¸
    idx = next((i for i, l in enumerate(LEAGUES) if l["name"] == current_league), 0)

    # Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð»Ð¸Ð³Ð°
    if idx >= len(LEAGUES) - 1:
        return {
            "can_level_up": False,
            "current_league": current_league,
            "next_league": None,
            "need_stars": 0,
            "need_xp": 0
        }

    next_l = LEAGUES[idx + 1]

    need_stars = max(0, next_l["stars"] - stars_user)
    need_xp = max(0, next_l["xp"] - xp_user)

    can_level_up = (need_stars == 0 and need_xp == 0)

    return {
        "can_level_up": can_level_up,
        "current_league": current_league,
        "next_league": next_l,
        "need_stars": need_stars,
        "need_xp": need_xp,
    }


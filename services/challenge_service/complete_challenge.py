from db.db import database
from aiogram import Bot


async def complete_challenge(habit_id: int, user_id: int, bot: Bot):
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ –¥–æ —É–¥–∞–ª–µ–Ω–∏—è
    row = await database.fetch_one("""
        SELECT name, description, days, done_days
        FROM habits
        WHERE id = :habit_id AND user_id = :user_id
    """, {"habit_id": habit_id, "user_id": user_id})

    if not row:
        return  # –ï—Å–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞

    name = row["name"]
    description = row["description"]
    done_days = row["done_days"]
    total_days = row["days"]

    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ completed_challenges
    await database.execute("""
        INSERT INTO completed_challenges (user_id, name, description, days, done_days, completed_at)
        VALUES (:user_id, :name, :description, :days, :done_days, CURRENT_TIMESTAMP)
    """, {
        "user_id": user_id,
        "name": name,
        "description": description,
        "days": total_days,
        "done_days": done_days,
    })

    # 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
    await database.execute("""
        UPDATE users
        SET finished_challenges = finished_challenges + 1
        WHERE user_id = :user_id
    """, {"user_id": user_id})

    # 3. –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤—ã—á–∫—É
    await database.execute("""
        DELETE FROM habits
        WHERE id = :habit_id AND user_id = :user_id
    """, {"habit_id": habit_id, "user_id": user_id})

    # 4. –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await bot.send_message(
        user_id,
        f"üèÜ <b>–ß–µ–ª–ª–µ–Ω–¥–∂ ¬´{name}¬ª –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n\n"
        f"<b>{done_days} –∏–∑ {total_days} –¥–Ω–µ–π</b> –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.\n"
        f"–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –≤–∑—è—Ç—å –Ω–æ–≤—ã–π –≤—ã–∑–æ–≤ üí™",
        parse_mode="HTML"
    )

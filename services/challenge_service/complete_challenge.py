import sqlite3
from config import DB_PATH
from aiogram import Bot

async def complete_challenge(habit_id: int, user_id: int, bot: Bot):
    with sqlite3.connect(DB_PATH) as conn:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ –î–û —É–¥–∞–ª–µ–Ω–∏—è
        cursor = conn.execute("SELECT name, done_days, days FROM habits WHERE id = ? AND user_id = ?", (habit_id, user_id))
        row = cursor.fetchone()
        if not row:
            return  # –ï—Å–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

        name, done_days, total_days = row

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
        conn.execute("""
            UPDATE users
            SET finished_challenges = finished_challenges + 1
            WHERE user_id = ?
        """, (user_id,))

        # –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤—ã—á–∫—É
        conn.execute("DELETE FROM habits WHERE id = ? AND user_id = ?", (habit_id, user_id))

    # üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –≤ —á–∞—Ç
    await bot.send_message(
        user_id,
        f"üèÜ <b>–ß–µ–ª–ª–µ–Ω–¥–∂ ¬´{name}¬ª –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n\n"
        f"<b>{done_days} –∏–∑ {total_days} –¥–Ω–µ–π</b> –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.\n"
        f"–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –≤–∑—è—Ç—å –Ω–æ–≤—ã–π –≤—ã–∑–æ–≤ üí™",
        parse_mode="HTML"
    )

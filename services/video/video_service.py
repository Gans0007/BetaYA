import logging
from repositories.video.video_repo import (
    save_pending_video,
    get_pending_videos,
    get_pending_video_by_id,
    delete_video,
    approve_video,
    count_pending_videos_by_user,
)
from services.monetization.reward_service import add_reward

logger = logging.getLogger(__name__)

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ
async def start_video_upload(user_id: int):
    pending_count = await count_pending_videos_by_user(user_id)
    return pending_count


# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
async def submit_video_link(user_id: int, video_url: str):
    await save_pending_video(user_id=user_id, video_link=video_url)


# –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
async def list_pending_videos():
    return await get_pending_videos()


# –ê–¥–º–∏–Ω –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –≤–∏–¥–µ–æ
async def reject_video(video_id: int, bot):
    video = await get_pending_video_by_id(video_id)
    if video:
        try:
            await bot.send_message(
                video["user_id"],
                "‚ùå –í–∞—à–µ –≤–∏–¥–µ–æ –±—ã–ª–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç."
            )
        except Exception as e:
            logger.error(f"[VIDEO] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: {e}")

    await delete_video(video_id)


# –ê–¥–º–∏–Ω –æ–¥–æ–±—Ä—è–µ—Ç –≤–∏–¥–µ–æ
async def approve_video_and_reward(video_id: int, admin_id: int, bot):
    await approve_video(video_id)
    video = await get_pending_video_by_id(video_id)
    if not video:
        return

    user_id = video["user_id"]
    logger.info(f"[ADMIN] ‚úÖ {admin_id} –æ–¥–æ–±—Ä–∏–ª –≤–∏–¥–µ–æ {video_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É
    await add_reward(user_id=user_id, amount=0.10, reason="–í–∏–¥–µ–æ –æ–¥–æ–±—Ä–µ–Ω–æ", reward_type="usdt")

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await bot.send_message(user_id, "‚úÖ –í–∞—à–µ –≤–∏–¥–µ–æ –±—ã–ª–æ –æ–¥–æ–±—Ä–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!")
        await bot.send_message(
            user_id,
            "–¢–µ–±–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –æ—Ç YA \n\n‚≠ê <b>+3 XP</b> –∑–∞ —Å—Ç–∞—Ä–∞–Ω–∏–µ\n\nüí∏ <b>+0.10 USDT</b> –∑–∞ –≤–∫–ª–∞–¥ –≤ –∫–æ–º—å—é–Ω–∏—Ç–∏!",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"[VIDEO] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

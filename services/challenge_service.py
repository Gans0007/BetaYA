from data.challenges_data import LEVEL_UNLOCKS, CHALLENGES, CHALLENGE_LEVELS, LEVEL_QUOTES
from repositories.challenge_repository import (
    get_user_total_stars,
    get_active_challenges,
    get_completed_challenges,
    insert_challenge_to_active,
    mark_challenge_completed
)


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Ä–æ–≤–Ω—é —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
#     –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ—Ç–∫—Ä—ã—Ç –ª–∏ —É—Ä–æ–≤–µ–Ω—å –Ω–∞ –æ—Å–Ω–æ–≤–µ ‚≠ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
#     - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
#     - –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL
#     - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram
# =====================================================
def is_level_unlocked(level_key: str, user_stars: int) -> bool:
    return user_stars >= LEVEL_UNLOCKS.get(level_key, 0)


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Ä–æ–≤–Ω—è—Ö
#     –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#       ‚Ä¢ —Å–∫–æ–ª—å–∫–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚≠ê
#       ‚Ä¢ –Ω–∞–∑–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π
#     - –Ω–∏–∫–∞–∫–æ–≥–æ SQL –∑–¥–µ—Å—å –Ω–µ—Ç
#     - –≤—Å—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
# =====================================================
async def get_level_info(user_id: int):
    stars = await get_user_total_stars(user_id)
    return stars, CHALLENGE_LEVELS["ru"]


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: —Å–±–æ—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞–º —É—Ä–æ–≤–Ω—è
#     –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#       ‚Ä¢ —Å–ø–∏—Å–æ–∫ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π —É—Ä–æ–≤–Ω—è
#       ‚Ä¢ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
#       ‚Ä¢ —Å–ø–∏—Å–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
#       ‚Ä¢ –º–∞–ø—É —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π
#     - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
#     - –≤—Å—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –∏–¥—ë—Ç —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
# =====================================================
async def get_challenge_list(user_id: int, level_key: str):
    active_rows = await get_active_challenges(user_id)
    completed_rows = await get_completed_challenges(user_id)

    active_ids = {row["challenge_id"] for row in active_rows}
    active_diff = {row["challenge_id"]: row["difficulty"] for row in active_rows}

    completed = {row["challenge_id"]: row["repeat_count"] for row in completed_rows}

    return CHALLENGES[level_key], active_ids, active_diff, completed


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —á–µ–ª–ª–µ–Ω–¥–∂–∞
#     ‚Ä¢ 0 –ø–æ–≤—Ç–æ—Ä–æ–≤ ‚Üí —Å–ª–æ–∂–Ω–æ—Å—Ç—å 1
#     ‚Ä¢ 1 –ø–æ–≤—Ç–æ—Ä ‚Üí —Å–ª–æ–∂–Ω–æ—Å—Ç—å 2
#     ‚Ä¢ 2+ –ø–æ–≤—Ç–æ—Ä–æ–≤ ‚Üí —Å–ª–æ–∂–Ω–æ—Å—Ç—å 3
#     - —á–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
# =====================================================
def get_difficulty(repeat: int) -> int:
    return min(repeat + 1, 3)


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ–ª–ª–µ–Ω–¥–∂–∞
#     ‚Ä¢ –ø–µ—Ä–≤—ã–π —Ä–∞–∑: 7 –¥–Ω–µ–π
#     ‚Ä¢ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑: 10 –¥–Ω–µ–π
#     ‚Ä¢ —Ç—Ä–µ—Ç–∏–π —Ä–∞–∑: 14 –¥–Ω–µ–π
#     - —á–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
# =====================================================
def get_days_for_repeat(repeat: int) -> int:
    return 7 if repeat == 0 else 10 if repeat == 1 else 14


# =====================================================
# üîπ –°–µ—Ä–≤–∏—Å: –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
#     ‚Ä¢ —Å—á–∏—Ç–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å
#     ‚Ä¢ —Å—á–∏—Ç–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
#     ‚Ä¢ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
#     ‚Ä¢ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏
#     - –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL
#     - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Telegram
# =====================================================
async def activate_challenge(user_id: int, cid: str, title: str,
                             desc_dict: dict, repeat: int, ctype: str):
    difficulty = get_difficulty(repeat)
    days = get_days_for_repeat(repeat)
    desc = desc_dict[difficulty]

    await insert_challenge_to_active(
        user_id, title, desc, days, ctype, cid, difficulty
    )

    return difficulty, days

from repositories.habits.habit_repo import get_habit_by_id
from services.confirmations.confirmation_service import process_confirmation, send_to_public_chat
from services.challenge_service.complete_challenge import complete_challenge

async def confirm_media_habit(user, habit_id: int, file_id: str, file_type: str, bot):
    """
    –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏ —á–µ—Ä–µ–∑ –º–µ–¥–∏–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏, –∏ –¥–ª—è –∞–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
    """
    habit = await get_habit_by_id(habit_id)
    if not habit:
        return "‚ùå –ü—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è wake_time
    if habit.confirm_type == "wake_time":
        from services.habits.habit_confirmation_service import check_wake_time
        ok, error = await check_wake_time(habit.name)
        if not ok:
            return error

    # –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    progress_increased = await process_confirmation(
        user_id=user.id,
        habit_id=habit_id,
        file_id=file_id,
        file_type=file_type,
        bot=bot
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø–∞–±–ª–∏–∫-—á–∞—Ç (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    await send_to_public_chat(
        user=user,
        habit_id=habit_id,
        file_id=file_id,
        file_type=file_type,
        bot=bot
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ–ª–ª–µ–Ω–¥–∂–∞
    if progress_increased:
        habit = await get_habit_by_id(habit_id)

        # –ê—á–∏–≤–∫–∞ –∑–∞ 3 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥
        from services.achievements.simple_achievements import show_achievement
        if habit.done_days == 3:
            await show_achievement(bot, user.id, "streak_3")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
        if habit.is_challenge and int(habit.done_days) >= int(habit.days):
            await complete_challenge(habit_id, user.id, bot)
            return "üèÜ –ß–µ–ª–ª–µ–Ω–¥–∂ –∑–∞–≤–µ—Ä—à—ë–Ω!"

    return (
        "‚úÖ –ü—Ä–∏–≤—ã—á–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—ë–Ω."
        if progress_increased
        else "‚ôªÔ∏è –ú–µ–¥–∏–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ! –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –∏–∑–º–µ–Ω—ë–Ω."
    )
